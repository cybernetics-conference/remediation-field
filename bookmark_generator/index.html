<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<link href='https://fonts.googleapis.com/css?family=Roboto+Mono:400,700|Source+Sans+Pro:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/lodash.js/3.4.0/lodash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prefixfree/1.0.7/prefixfree.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.0.5/vue.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>

<script src="js/qrcode.min.js"></script>

<script>
var getUrlValue = function(VarSearch){
    var SearchString = window.location.search.substring(1);
    var VariableArray = SearchString.split('&');
    for(var i = 0; i < VariableArray.length; i++){
        var KeyValuePair = VariableArray[i].split('=');
        if(KeyValuePair[0] === VarSearch){
            return KeyValuePair[1];
        }
    }
}


</script>

<!--<link rel="stylesheet" href="css/bookmark.css" /> -->


<style type="text/css">
body {
	margin: 0px;
	padding: 0px;
  font-family: 'Roboto Mono';
}
.flexcontainer {
	display: flex;
	align-items: center;
	justify-content: center;
	flex-direction:row;
}

.centerdiv {
}

#bookmark {
  background-image: url("../img/slip_template.svg");
  background-repeat: no-repeat;
  height: 960px;
    width: 400px;
  position: relative;
}

.b_elem {
  position: absolute;
  display: flex;
  align-items: left;
  flex-direction: column;
  justify-content: center;
  font-size: 0.9em;
}

#qrcode * {
  width: 170px; height: 170px; 
}


#cylibid { top: 168px; left: 55px}
#cylibid_id { top: 185px; left: 55px; }
#qrcode { top: 33px; left: 205px}
#mark-title { top: 271px; left: 50px}
#mark-authors { top: 385px; left: 50px}
#mark-publication { top: 477px; left: 50px}
#mark-source { top: 548px; left: 50px}
#mark-tags { top: 625px; left: 5px}

#cylibid { text-align: center; width: 100px;}
#cylibid_id { text-align: center; width: 100px;}
#mark-title {  height: 115px;  width: 340px;  text-align: left; }
#mark-authors {  height: 90px;  width: 340px;  text-align: left; }
#mark-publication {  height: 70px;  width: 340px;  text-align: left; }
#mark-source {  height: 53px;  width: 340px;  text-align: left; font-size: 0.8em; }
#mark-tags { width: 140px; height: 260px; font-size: 0.5em; align-items: flex-start; }


.booklist {
    height: 50vh;
    overflow: auto;
}

</style>

<!-- 
///////////////
CUSTOMIZE BELOW
/////////////// -->

<title>CYBERNETICS LIBRARY BOOKMARK GENERATOR</title>

</head>
<body>
  <div class="flexcontainer" id="app">
    <collection-selector :collections="collections"></collection-selector>
    <book-selector :books="books" v-on:bookid-change=onBookidChange></book-selector>
	<div class="centerdiv">
    <div id="bookmark">
      {{thisbook.bookid}}
      <div class="b_elem" id="cylibid">CYLIB-ID</div>
      <div class="b_elem" id="cylibid_id">{{ thisbook.bookid }}</div>
      <div class="b_elem" id="qrcode"></div>
      <div class="b_elem" id="mark-title">{{ thisbook.title }}</div>
      <div class="b_elem" id="mark-authors">{{ thisbook.authors }}</div>
      <div class="b_elem" id="mark-publication">{{ thisbook.publication }}</div>
      <div class="b_elem" id="mark-source">Inter-Library Loan from the collection of: <br /><b>{{ thisbook.source }}</b></div>
      <div class="b_elem" id="mark-tags">{{ thisbook.tags }}</div>



    </div>



	</div>
</div>
<script>

var cs = Vue.component('collection-selector', {
props: ["collections"],
data: function () {
  return {
    count: 0,
    collections: []
  }
},
methods: {
  collinc: function(inc) {
    this.count += inc;
    this.count += Object.keys(this.collections).length;
    this.count %= Object.keys(this.collections).length;
  }
},
template: `
<div>
  <div><button v-on:click=collinc(-1)>^</button><button v-on:click="collinc(1)">v</button></div>
  <div v-for="(value, key, index) in collections">
  <div v-if="index == count"><b>{{value}}</b></div>
  <div v-else>{{value}}</div>
  </div>
</div>  `
})


var cs = Vue.component('book-selector', {
props: ["books"],
data: function () {
  return {
    count: 0,
    books: []
  }
},
methods: {
  bookinc: function(inc) {
    this.count += inc;
    this.count += Object.keys(this.books).length;
    this.count %= Object.keys(this.books).length;
    this.$emit('bookid-change', Object.keys(this.books)[this.count])
  }
},
template: `
<div class="book-selector">
  <div class="selector"><button v-on:click="bookinc(-1)">^</button><button v-on:click="bookinc(1)">v</button></div>
  <div class ="booklist">
    <div class="book" v-for="(value, key, index) in books">
      <template v-if="index == count"><b>{{value.title}}</b></template>
      <template v-else>{{value.title}}</template>
    </div>
  </div>
</div>  `
})


var bm = new Vue({
  el: '#app',
  methods: {
    loadData() {
      var self = this;
      self.$data.id = getUrlValue("bookid");

      
      var apiurl = "http://www.librarything.com/api_getdata.php?userid=cyberneticscon&showstructure=1&max=1000&showTags=10&booksort=title_REV&showCollections=1";

      $.ajax({
        type: 'GET',
        url: apiurl,
        dataType: 'jsonp',
        success: function(d) {
          self.$data.books = d.books;
          self.$data.collections = _.reduce(_.map(d.books, 'collections'), function(tot, current) { return _.assign(tot, current) }, {})
          console.log(d);
        }
      });

    },
    onBookidChange(bookid) {
      console.log(bookid);
      this.thisbook = this.books[bookid];
    }
  },
  mounted() {

    this.loadData()


    var qr = new QRCode(document.getElementById("qrcode"), {
      text: "https://library.cybernetics.social/checkout/" + this.$data.id
    });

    console.log(this.$data.id);
    console.log("dho");



    console.log($(".b_elem" ));
//    $(".b_elem" ).draggable();

  },
  data: {
    thisbook: {
      bookid: 147800304,
      title: "Radical reconstruction",
      author: "Woods, Lebbeus",
      publication: "New York : Princeton Architectural Press, c1997.",
      tags: "Architecture and society, Architecture--Philosophy, Architecture, Philosophy",
      source: "David Hecht",
    },
    collections: [],
    books: []
  }
})
</script>
</body>
</html>




